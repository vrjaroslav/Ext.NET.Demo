@{
    var X = Html.X();
    ViewBag.Title = "Uber Baker";
    Layout = "~/Views/Shared/_BaseLayout.cshtml";
}

@section headtag
{
    <script>
        var saveChart = function(btn) {
            Ext.MessageBox.confirm('Confirm Download', 'Would you like to download the chart as an image?', function(choice) {
                if (choice == 'yes') {
                    btn.up('panel').down('chart').save({
                        type: 'image/png'
                    });
                }
            });
        };

        var addRecordButtonHandler = function(type, record) {
            App[type + "SaveButton"].disable();
            App[type + "CancelButton"].enable();
            App[type + 'Spot'].show(App[type + 'Form']);
            App[type + 'Form'].reset();
            App[type + 'Grid'].getSelectionModel().deselectAll();
            focusFormField(App[type + 'Form'].getForm());
        };

        var checkGridSelection = function(grid) {
            return grid.getSelectionModel().getSelection().length > 0;
        };

        var getSelectedIdParameter = function(grid) {
            return grid.getSelectionModel().getSelection()[0].data.Id;
        };

        var recordDeleteSuccess = function(button, grid, type) {
            grid.getStore().reload();
            App[type + 'Form'].reset();
        };

        var gridRowSelected = function(type, record) {
            App[type + "DeleteButton"].enable();
            App[type + "SaveButton"].enable();
            App[type + "CancelButton"].enable();
            App[type + 'Form'].getForm().loadRecord(record);
            App[type + 'Id'].setValue(record.get('Id'));
            focusFormField(App[type + 'Form'].getForm());
        };

        var gridRowDeselected = function(type, record) {
            App[type + "DeleteButton"].disable();
        };

        var recordAddSuccess = function(type) {
            if (App[type + 'Spot'].active)
                App[type + 'Spot'].hide();
            App[type + 'Form'].reset(true);
            App[type + 'Grid'].getStore().reload();
        };

        var recordSaveCancel = function (type) {
            App[type + 'Form'].reset(true);
            if (App[type + 'Spot'].active)
                App[type + 'Spot'].hide();
            App[type + "SaveButton"].disable();
            App[type + "CancelButton"].disable();
            App[type + 'Grid'].getSelectionModel().deselect(App[type + 'Form'].getRecord());
        };

        var focusFormField = function (form) {
            var field = form.getFields().findBy(function (field) { return field.isXType('textfield'); });
            if (field)
                field.inputEl.focus(10);
        };
        
        var validityChange = function (type, valid) {
            App[type + "SaveButton"].setDisabled(!valid);
        };
    </script>
}

@section bodytag
{
    <script>
        @(X.XScript()
            .ScriptBlock(@"
                var beforeTabOpen = function(param) {
                    var tab = #{MainTabPanel}.getComponent(param); 
                    if (tab) { 
                        #{MainTabPanel}.setActiveTab(tab); 
                        return false; 
                    }
                }
            ")
       )
    </script>

    @(X.Spotlight()
        .ID("ProductsSpot")
        .Easing(Easing.EaseIn)
        .Duration(1))
    
    @(X.Spotlight()
        .ID("ProductTypesSpot")
        .Easing(Easing.EaseIn)
        .Duration(1)
    )
    
    @(X.Spotlight()
        .ID("OrdersSpot")
        .Easing(Easing.EaseIn)
        .Duration(1)
    )
    
    @(X.Spotlight()
        .ID("CustomersSpot")
        .Easing(Easing.EaseIn)
        .Duration(1)
    )
    
    @(X.Spotlight()
        .ID("UsersSpot")
        .Easing(Easing.EaseIn)
        .Duration(1)
    )
    
    @(X.Window()
        .ID("UserProfileWindow")
        .Title("User Profile")
        .Hidden(true)
        .Modal(true)
    )

    @(X.Viewport()
        .Layout(LayoutType.Fit)
        .Items(
            X.Panel()
                .Layout(LayoutType.Border)
                .TopBar(
                    X.Toolbar()
                        .Items(i => i.Add(
                            X.SplitButton()
                            .Text("Uber Baker Demo Application")
                            .MenuAlign("tr-br?")
                            .Menu(X.Menu()
                                .Items(
                                    X.MenuItem()
                                        .Text("Profile")
                                        .Icon(Icon.User)
                                        .DirectEvents(de =>
                                        {
                                            //de.Click.Url = Url.Action("ProfileWindow", "Profiles");
                                            de.Click.Url = Url.Action("ProfilePanel", "Profiles");
                                            de.Click.ExtraParams.Add(new { containerId = "MainTabPanel" });
                                            de.Click.ExtraParams.Add(new { tabId = "ProfilePanel" });
                                            de.Click.EventMask.ShowMask = true;
                                            de.Click.EventMask.Msg = "Loading...";
                                            de.Click.Before = "return beforeTabOpen(extraParams['tabId']);";
                                            de.Click.Timeout = 120000;
                                        }),
                                        
                                    X.MenuItem()
                                        .Text("Log Out")
                                        .Icon(Icon.DoorOut)
                                        .DirectEvents(de =>
                                        {
                                            de.Click.Confirmation.ConfirmRequest = true;
                                            de.Click.Confirmation.Message = "Are you sure you want to log out?";
                                            de.Click.Url = Url.Action("LogOff", "Account");
                                        })
                                )
                            )
                            )
                        )
                )
                .Items(
                    X.MenuPanel()
                        .Region(Region.West)
                        .Width(215)
                        .Split(true)
                        .Menu(m =>
                        {
                            m.Add(X.MenuItem()
                                .Icon(Icon.ApplicationViewList)
                                .Text("Products")
                                .DirectEvents(
                                    de =>
                                    {
                                        de.Click.Action = "RenderTab";
                                        de.Click.ExtraParams.Add(new {containerId = "MainTabPanel"});
                                        de.Click.ExtraParams.Add(new { tabId = "ProductsPanel" });
                                        de.Click.EventMask.ShowMask = true;
                                        de.Click.EventMask.Msg = "Loading...";
                                        de.Click.Before = "return beforeTabOpen(extraParams['tabId']);";
                                        de.Click.Timeout = 120000;
                                    }
                                )
                            );

                            m.Add(X.MenuItem()
                                .Icon(Icon.Basket)
                                .Text("ProductTypes")
                                .DirectEvents(
                                    de =>
                                    {
                                        de.Click.Action = "RenderTab";
                                        de.Click.ExtraParams.Add(new {containerId = "MainTabPanel"});
                                        de.Click.ExtraParams.Add(new { tabId = "ProductTypesPanel" });
                                        de.Click.EventMask.ShowMask = true;
                                        de.Click.EventMask.Msg = "Loading...";
                                        de.Click.Before = "return beforeTabOpen(extraParams['tabId']);";
                                        de.Click.Timeout = 120000;
                                    }
                                )
                            );

                            m.Add(X.MenuItem()
                                .Text("Customers")
                                .Icon(Icon.UserSuitBlack)
                                .DirectEvents(
                                    de =>
                                    {
                                        de.Click.Action = "RenderTab";
                                        de.Click.ExtraParams.Add(new {containerId = "MainTabPanel"});
                                        de.Click.ExtraParams.Add(new { tabId = "CustomersPanel" });
                                        de.Click.EventMask.ShowMask = true;
                                        de.Click.EventMask.Msg = "Loading...";
                                        de.Click.Before = "return beforeTabOpen(extraParams['tabId']);";
                                        de.Click.Timeout = 120000;
                                    }
                                )
                            );

                            m.Add(X.MenuItem()
                                .Icon(Icon.Bookmark)
                                .Text("Orders")
                                .DirectEvents(
                                    de =>
                                    {
                                        de.Click.Action = "RenderTab";
                                        de.Click.ExtraParams.Add(new { containerId = "MainTabPanel" });
                                        de.Click.ExtraParams.Add(new { tabId = "OrdersPanel" });
                                        de.Click.EventMask.ShowMask = true;
                                        de.Click.EventMask.Msg = "Loading...";
                                        de.Click.Before = "return beforeTabOpen(extraParams['tabId']);";
                                        de.Click.Timeout = 120000;
                                    }
                                )
                            );

                            m.Add(X.MenuItem()
                                .Text("Orders Chart")
                                .Icon(Icon.TableMultiple)
                                .DirectEvents(
                                    de =>
                                    {
                                        de.Click.Action = "RenderTab";
                                        de.Click.ExtraParams.Add(new {containerId = "MainTabPanel"});
                                        de.Click.ExtraParams.Add(new { tabId = "OrdersChartPanel" });
                                        de.Click.EventMask.ShowMask = true;
                                        de.Click.EventMask.Msg = "Loading...";
                                        de.Click.Before = "return beforeTabOpen(extraParams['tabId']);";
                                        de.Click.Timeout = 120000;
                                    }
                                )
                            );
                            
                            m.Add(X.MenuItem()
                                .Text("Users")
                                .Icon(Icon.StatusOnline)
                                .DirectEvents(
                                    de =>
                                    {
                                        de.Click.Action = "RenderTab";
                                        de.Click.ExtraParams.Add(new {containerId = "MainTabPanel"});
                                        de.Click.ExtraParams.Add(new { tabId = "UsersPanel" });
                                        de.Click.EventMask.ShowMask = true;
                                        de.Click.EventMask.Msg = "Loading...";
                                        de.Click.Before = "return beforeTabOpen(extraParams['tabId']);";
                                        de.Click.Timeout = 120000;
                                    }
                                )
                            );
                        }),
                        
                    X.TabPanel()
                        .ID("MainTabPanel")
                        .Region(Region.Center)
                        .MinTabWidth(100)
                        .Plugins(plugins => plugins.Add(new TabCloseMenu()))
                        .Items(
                            X.Panel()
                                .Layout(LayoutType.Fit)
                                .Title("Dashboard")
                                .Items(
                                    X.Portal()
                                        .Border(false)
                                        .Items(
                                            X.PortalColumn()
                                                .ItemsFromPartial("DashboardChart")
                                        )
                                )
                        )
                )
        )
    )   
}